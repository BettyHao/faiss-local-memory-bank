pip install -U openai faiss-cpu pandas tqdm
from openai import OpenAI
import json
import faiss
import numpy as np
from tqdm import tqdm

# âœ… æ›¿æ¢ä¸ºä½ çš„ AihubMix API Key
client = OpenAI(
    api_key="sk-**************",   ###è¿™é‡ŒæŠŠå¼•å·å†…æ¢æˆè‡ªå·±çš„api,å®˜ç½‘apiä¹Ÿå¯ä»¥ç”¨ï¼Œä½†è¦æ¢ä¸ªå†™æ³•
    base_url="https://aihubmix.com/v1"
)

# åŠ è½½ä½ çš„å¯¹è¯æ–‡æœ¬
with open("processed_dialogues.json", "r", encoding="utf-8") as f:   ###è¿™é‡Œæ–‡ä»¶åå’Œåœ°å€è¦ä¸é¢„å¤„ç†æ—¶çš„è¾“å‡ºæ–‡ä»¶ä¿æŒä¸€è‡´
    data = json.load(f)

vectors = []
metadata = []

print("ğŸ“Œ æ­£åœ¨ç”ŸæˆåµŒå…¥å‘é‡...")
for i, item in enumerate(tqdm(data)):
    text = item["text"]
    try:
        response = client.embeddings.create(
            input=text,
            model="text-embedding-3-small"
        )
        embedding = response.data[0].embedding
        vectors.append(embedding)
        metadata.append(item)
    except Exception as e:
        print(f"âŒ ç¬¬ {i} æ¡å‡ºé”™ï¼š{e}")
        continue

# æ„å»º FAISS ç´¢å¼•
dim = len(vectors[0])
index = faiss.IndexFlatL2(dim)
index.add(np.array(vectors).astype("float32"))
faiss.write_index(index, "chat_memory.index")

# ä¿å­˜ metadata
with open("chat_memory_metadata.json", "w", encoding="utf-8") as f:
    json.dump(metadata, f, ensure_ascii=False, indent=2)

print("âœ… åµŒå…¥å®Œæˆå¹¶ä¿å­˜ FAISS å‘é‡åº“ã€‚")
