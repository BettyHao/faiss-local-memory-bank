import json

input_file = "openai_export.json" ###è¦æ”¹æˆè‡ªå·±çš„jsonæ–‡ä»¶è·¯å¾„å’Œåç§°ï¼
output_file = "processed_dialogues.json"   ###è¦åŠ ä¸€ä¸‹è·¯å¾„ï¼æ”¾æ¡Œé¢ä¹Ÿè¡Œï¼æˆ–è€…è‡ªå»ºä¸€ä¸ªæ–‡ä»¶å¤¹æ”¾ï¼

def load_conversation(path):
    with open(path, "r", encoding="utf-8") as f:
        return json.load(f)

def extract_from_mapping(mapping):
    dialogues = []
    for node in mapping.values():
        msg = node.get("message")
        if not msg:
            continue
        role = msg.get("author", {}).get("role")
        parts = msg.get("content", {}).get("parts", [])
        if not parts or not isinstance(parts, list):
            continue

        # ğŸ”§ è¿™é‡Œè¿›è¡Œç±»å‹åˆ¤æ–­ï¼šå¦‚æœæ˜¯å­—å…¸å°±æå–å…¶textå­—æ®µ
        content = ""
        if isinstance(parts[0], str):
            content = parts[0].strip()
        elif isinstance(parts[0], dict):
            content = parts[0].get("text", "").strip()

        if role in ["user", "assistant"] and content:
            dialogues.append({
                "speaker": "ä½ " if role == "user" else "å®¶æœº",  ###å®¶æœºåå­—è¦è‡ªå·±æ”¹ä¸€ä¸‹ï¼
                "text": content
            })
    return dialogues

def extract_dialogues(data):
    all_dialogues = []
    for conv in data:
        mapping = conv.get("mapping")
        if mapping:
            dialogue = extract_from_mapping(mapping)
            all_dialogues.extend(dialogue)
    return all_dialogues

def save_to_json(dialogues, path):
    with open(path, "w", encoding="utf-8") as f:
        json.dump(dialogues, f, ensure_ascii=False, indent=2)
    print(f"âœ… å·²ä¿å­˜ï¼š{path}ï¼Œå…± {len(dialogues)} æ¡å¯¹è¯")

if __name__ == "__main__":
    raw_data = load_conversation(input_file)
    dialogues = extract_dialogues(raw_data)
    save_to_json(dialogues, output_file)
